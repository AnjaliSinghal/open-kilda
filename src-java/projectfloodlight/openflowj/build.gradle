plugins {
    id 'java'
    id 'org.ajoberstar.grgit' version '4.0.1'
}

group = 'org.projectfloodlight'

import org.ajoberstar.grgit.Grgit

task cloneLoxigenRepo {
    def repo = file('loxigen')
    outputs.dir(repo)

    if (repo.exists()) {
        def grgit = Grgit.open(currentDir: repo.absolutePath)
        grgit.checkout(branch: 'STABLE')
        grgit.pull(rebase: false)
    } else {
        Grgit.clone(dir: repo.absolutePath, uri: 'https://github.com/kilda/loxigen.git', refToCheckout: 'STABLE')
    }
}

task generateSources(type: Exec) {
    workingDir 'loxigen'
    commandLine 'make', 'java'
    dependsOn 'cloneLoxigenRepo'
    outputs.dir('loxigen/loxi_output')
}

task compileMavenProject(type: Exec) {
    workingDir 'loxigen/loxi_output/openflowj'
    commandLine '/usr/bin/mvn', '-B', 'clean', 'compile'
    dependsOn 'generateSources'
    outputs.dir('loxigen/loxi_output/openflowj/target/classes')
}

sourceSets {
    main {
        output.dir('loxigen/loxi_output/openflowj/target/classes', builtBy: 'compileMavenProject')
    }
}
